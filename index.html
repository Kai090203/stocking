<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Trader Pro - Security</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body { background-color: #f0f2f5; color: #333; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        
        /* --- ë¡œê·¸ì¸ í™”ë©´ (ì—…ë°ì´íŠ¸ë¨) --- */
        #loginScreen { position: absolute; z-index: 1000; background: rgba(255,255,255,0.98); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center; width: 320px; border: 1px solid #e1e4e8; }
        .login-title { font-size: 1.8rem; font-weight: 800; color: #2f3542; margin: 0 0 10px 0; }
        .login-desc { color: #747d8c; margin-bottom: 25px; font-size: 0.95rem; }
        .login-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; transition: 0.2s; }
        .login-input:focus { border-color: #333; }
        .btn-login { width: 100%; padding: 14px; background: #2f3542; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; margin-top: 10px; }
        .btn-login:hover { background: #57606f; }
        .login-msg { margin-top: 15px; font-size: 0.85rem; color: #ff4757; min-height: 20px; }

        /* --- ë‰´ìŠ¤ë°” --- */
        .news-container { position: absolute; top: 0; width: 100%; background: #fff; height: 50px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #ddd; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .news-badge { padding: 4px 10px; border-radius: 20px; color: white; font-size: 0.8rem; font-weight: bold; margin-right: 10px; }
        .badge-red { background: #ff4757; } .badge-blue { background: #1e90ff; } .badge-gray { background: #747d8c; }
        #newsText { font-weight: 600; font-size: 1rem; color: #2f3542; }

        /* --- ë©”ì¸ UI --- */
        .main-container { display: none; gap: 20px; width: 95%; max-width: 1100px; height: 85vh; margin-top: 60px; }
        .panel { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; border: 1px solid #e1e4e8; }
        
        /* ì™¼ìª½ (ì°¨íŠ¸/ë§¤ë§¤) */
        .left-panel { flex: 1.8; padding: 25px; position: relative; }
        .coin-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .coin-name-big { font-size: 2rem; font-weight: 800; color: #2f3542; }
        .coin-price-big { font-size: 2.4rem; font-weight: 900; }
        .price-up { color: #ff4757; } .price-down { color: #1e90ff; }
        
        #chartArea { width: 100%; height: 380px; border: 1px solid #eee; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        
        .trade-area { background: #f8f9fa; padding: 20px; border-radius: 12px; }
        .asset-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; color: #57606f; }
        .asset-val { font-weight: bold; color: #2f3542; font-size: 1.1rem; }
        
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; margin-top: 15px; }
        .qty-input { flex: 1; padding: 14px; border: 1px solid #ced6e0; border-radius: 8px; font-size: 1.2rem; text-align: right; outline: none; font-weight: bold; }
        .btn-max { padding: 0 20px; background: #a4b0be; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .btn-row { display: flex; gap: 10px; }
        .btn-trade { flex: 1; padding: 16px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; color: white; cursor: pointer; transition: 0.1s; }
        .btn-buy { background: #ff4757; box-shadow: 0 4px 0 #d63031; } .btn-buy:active { transform: translateY(4px); box-shadow: none; }
        .btn-sell { background: #1e90ff; box-shadow: 0 4px 0 #0984e3; } .btn-sell:active { transform: translateY(4px); box-shadow: none; }

        /* ì˜¤ë¥¸ìª½ (ë¦¬ìŠ¤íŠ¸) */
        .right-panel { flex: 1; display: flex; flex-direction: column; background: #fdfdfd; }
        .tab-header { display: flex; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 15px; cursor: pointer; text-align: center; font-weight: bold; color: #a4b0be; transition: 0.2s; background: #f1f2f6; }
        .tab-btn.active { background: white; color: #2f3542; border-top: 3px solid #333; }
        
        .list-container { flex: 1; overflow-y: auto; }
        .coin-item { padding: 15px 20px; border-bottom: 1px solid #f1f2f6; cursor: pointer; transition: 0.1s; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .coin-item:hover { background: #f8f9fa; }
        .coin-item.active { background: #eef2f5; border-left: 5px solid #2f3542; }
        
        .coin-info-left { display: flex; flex-direction: column; }
        .code-tag { font-size: 0.8rem; color: #a4b0be; font-weight: bold; }
        .name-tag { font-weight: bold; font-size: 1.05rem; color: #2f3542; }
        
        .coin-info-right { text-align: right; }
        .list-price { font-weight: bold; font-size: 1.05rem; }
        .list-pct { font-size: 0.9rem; font-weight: bold; margin-top: 4px; }
        
        .holding-badge { background: #2ed573; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .profit-pos { color: #ff4757; } .profit-neg { color: #1e90ff; }

        /* í† ìŠ¤íŠ¸ */
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; font-size: 0.9rem; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 class="login-title">ğŸ” Coin Trader</h2>
        <p class="login-desc">ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>(ì²˜ìŒ ì…ë ¥ ì‹œ ìë™ ê°€ì…)</p>
        
        <input type="text" id="username" class="login-input" placeholder="ì•„ì´ë”” (ID)" onkeypress="if(event.key==='Enter') document.getElementById('password').focus()">
        <input type="password" id="password" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (Password)" onkeypress="if(event.key==='Enter') tryLogin()">
        
        <button class="btn-login" onclick="tryLogin()">ì ‘ì†í•˜ê¸°</button>
        <div id="loginMsg" class="login-msg"></div>
    </div>
</div>

<div class="news-container">
    <div id="newsBadge" class="news-badge badge-gray">NEWS</div>
    <div id="newsText">ê¸€ë¡œë²Œ ë§ˆì¼“ ë°ì´í„° ì—°ê²° ì¤‘...</div>
    <button onclick="logout()" style="position:absolute; right:20px; padding:6px 12px; border:1px solid #ddd; background:white; cursor:pointer; border-radius:4px; font-weight:bold; color:#555;">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div class="main-container" id="mainGame">
    <div class="panel left-panel">
        <div class="coin-header">
            <div>
                <span class="code-tag" id="mainCode">BTC</span>
                <div class="coin-name-big" id="mainName">ë¹„íŠ¸ì½”ì¸</div>
            </div>
            <div class="coin-price-big" id="mainPrice">0</div>
        </div>

        <div id="chartArea"></div>

        <div class="trade-area">
            <div class="asset-row">
                <span>ë‚´ ì˜ˆìˆ˜ê¸ˆ</span>
                <span class="asset-val"><span id="myCash">0</span> KRW</span>
            </div>
            <div class="asset-row">
                <span>ë³´ìœ  ìˆ˜ëŸ‰</span>
                <span class="asset-val"><span id="myQty">0</span> <span id="qtyUnit">BTC</span></span>
            </div>
            
            <div class="input-row">
                <input type="number" id="tradeAmount" class="qty-input" placeholder="ìˆ˜ëŸ‰ ì…ë ¥">
                <button class="btn-max" onclick="setMax()">ìµœëŒ€</button>
            </div>
            <div class="btn-row">
                <button class="btn-trade btn-buy" onclick="trade('buy')">ë§¤ìˆ˜</button>
                <button class="btn-trade btn-sell" onclick="trade('sell')">ë§¤ë„</button>
            </div>
            <div style="text-align:center; margin-top:15px; color:#747d8c; font-size:0.9rem;">
                ì´ ìì‚° í‰ê°€: <b id="totalAsset" style="color:#333">0</b> KRW
            </div>
        </div>
    </div>

    <div class="panel right-panel">
        <div class="tab-header">
            <div class="tab-btn active" id="tabAll" onclick="switchTab('all')">ğŸŒ ì „ì²´ ì‹œì„¸</div>
            <div class="tab-btn" id="tabMy" onclick="switchTab('my')">ğŸ’¼ ë‚´ ì§€ê°‘</div>
        </div>
        <div class="list-container" id="coinList"></div>
    </div>
</div>

<div id="toast">ë©”ì‹œì§€</div>

<script>
    // --- ë°ì´í„° (ë³€ë™ì„± Volatility ê¸°ì¡´ ëŒ€ë¹„ ìƒí–¥ ì¡°ì •) ---
    const coinDb = [
        { code: "BTC", name: "ë¹„íŠ¸ì½”ì¸", price: 98500000, vol: 0.8 },
        { code: "ETH", name: "ì´ë”ë¦¬ì›€", price: 5200000, vol: 1.0 },
        { code: "XRP", name: "ë¦¬í”Œ", price: 900, vol: 1.5 },
        { code: "SOL", name: "ì†”ë¼ë‚˜", price: 210000, vol: 1.4 },
        { code: "BNB", name: "ë°”ì´ë‚¸ìŠ¤", price: 850000, vol: 0.9 },
        { code: "DOGE", name: "ë„ì§€ì½”ì¸", price: 220, vol: 3.0 }, // ë°ˆì½”ì¸ ë³€ë™ì„± í¼
        { code: "ADA", name: "ì—ì´ë‹¤", price: 750, vol: 1.2 },
        { code: "TRX", name: "íŠ¸ë¡ ", price: 160, vol: 1.0 },
        { code: "AVAX", name: "ì•„ë°œë€ì²´", price: 48000, vol: 1.5 },
        { code: "SHIB", name: "ì‹œë°”ì´ëˆ„", price: 0.04, vol: 4.0 }, // ì´ˆê³ ìœ„í—˜
        { code: "DOT", name: "í´ì¹´ë‹·", price: 11000, vol: 1.4 },
        { code: "LINK", name: "ì²´ì¸ë§í¬", price: 25000, vol: 1.6 },
        { code: "MATIC", name: "í´ë¦¬ê³¤", price: 1100, vol: 1.5 },
        { code: "LTC", name: "ë¼ì´íŠ¸ì½”ì¸", price: 115000, vol: 1.1 },
        { code: "BCH", name: "ë¹„íŠ¸ìºì‹œ", price: 650000, vol: 1.2 },
        { code: "UNI", name: "ìœ ë‹ˆìŠ¤ì™‘", price: 9500, vol: 1.8 },
        { code: "ETC", name: "ì´í´", price: 32000, vol: 2.0 },
        { code: "XLM", name: "ìŠ¤í…”ë¼", price: 190, vol: 1.3 },
        { code: "SAND", name: "ìƒŒë“œë°•ìŠ¤", price: 850, vol: 2.2 },
        { code: "PEPE", name: "í˜í˜", price: 0.008, vol: 5.0 } // ê·¹ì•… ë‚œì´ë„
    ];

    const newsData = [
        { type: 'good', text: "{name}, ëŒ€ê¸°ì—… ê²°ì œ ë„ì… í™•ì •!", power: 1.12 }, // 12% ìƒìŠ¹
        { type: 'good', text: "ê¸°ê´€, {name} 1ì¡°ì› ë§¤ìˆ˜ í¬ì°©", power: 1.08 },
        { type: 'good', text: "{name}, ë©”ì¸ë„· ì„±ê³µì  ëŸ°ì¹­", power: 1.06 },
        { type: 'good', text: "ë¯¸êµ­ SEC, {name} ETF ìŠ¹ì¸!", power: 1.15 }, // 15% ìƒìŠ¹
        { type: 'bad', text: "{name} ì¬ë‹¨, ë¨¹íŠ€ ë…¼ë€ ë°œìƒ", power: 0.85 }, // 15% í•˜ë½
        { type: 'bad', text: "í•´ì»¤, {name} ëŒ€ëŸ‰ íƒˆì·¨ ì„±ê³µ", power: 0.88 },
        { type: 'bad', text: "ê±°ë˜ì†Œ, {name} ìƒì¥íì§€ ì‹¬ì‚¬", power: 0.80 }, // 20% í•˜ë½
        { type: 'bad', text: "ê·œì œ ë‹¹êµ­, {name} ì¦ê¶Œì„± íŒì •", power: 0.90 },
        { type: 'info', text: "ë‚˜ìŠ¤ë‹¥ ê¸‰ë“±, ì½”ì¸ ì‹œì¥ í›ˆí’", power: 1.03 },
        { type: 'info', text: "FOMC ê¸ˆë¦¬ ì¸ìƒ ê³µí¬ í™•ì‚°", power: 0.97 }
    ];

    // ìƒíƒœ ë³€ìˆ˜
    let currentUser = "";
    let cash = 10000000;
    let coins = [];
    let wallet = {};
    let curIdx = 0;
    let curTab = 'all';
    
    // ì°¨íŠ¸
    let chart, series;
    let chartData = [];
    let lastTime = Math.floor(Date.now()/1000);
    let loopId;

    // --- ë¡œê·¸ì¸ ë¡œì§ (ë¹„ë²ˆ ê¸°ëŠ¥ ì¶”ê°€) ---
    function tryLogin() {
        const id = document.getElementById("username").value.trim();
        const pw = document.getElementById("password").value.trim();
        const msg = document.getElementById("loginMsg");
        
        if(!id || !pw) {
            msg.innerText = "ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }

        // ìœ ì € DB ë¡œë“œ (ì „ì²´ ìœ ì € ë¹„ë²ˆ ì €ì¥ìš©)
        let userDB = JSON.parse(localStorage.getItem("btcGame_Users") || "{}");

        if(userDB.hasOwnProperty(id)) {
            // ê¸°ì¡´ ìœ ì €
            if(userDB[id] === pw) {
                gameStart(id);
            } else {
                msg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
            }
        } else {
            // ì‹ ê·œ ìœ ì € -> ìë™ ê°€ì…
            userDB[id] = pw;
            localStorage.setItem("btcGame_Users", JSON.stringify(userDB));
            alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${id}ë‹˜!\nì…ë ¥í•˜ì‹  ë¹„ë°€ë²ˆí˜¸ë¡œ ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            gameStart(id);
        }
    }

    function gameStart(id) {
        currentUser = id;
        
        // ê°œë³„ ìœ ì € ê²Œì„ ë°ì´í„° ë¡œë“œ
        const saved = localStorage.getItem("btcGame_Data_" + currentUser);
        if(saved) {
            const data = JSON.parse(saved);
            cash = data.cash;
            wallet = data.wallet;
            // ì½”ì¸ ë°ì´í„° ë³‘í•© (ìƒˆë¡œìš´ ì½”ì¸ì´ ì¶”ê°€ëì„ ê²½ìš° ëŒ€ë¹„)
            coins = coinDb.map(init => {
                const found = data.coins.find(c => c.code === init.code);
                return found ? found : { ...init, openPrice: init.price };
            });
        } else {
            // ì´ˆê¸°í™”
            cash = 10000000;
            wallet = {};
            coins = JSON.parse(JSON.stringify(coinDb));
            coins.forEach(c => {
                c.openPrice = c.price; 
                wallet[c.code] = { qty: 0, avg: 0 };
            });
        }

        document.getElementById("loginScreen").style.display = 'none';
        document.getElementById("mainGame").style.display = 'flex';
        
        initChart();
        changeCoin(0);
        
        if(loopId) clearInterval(loopId);
        loopId = setInterval(gameLoop, 1000); 
    }

    function logout() {
        save();
        location.reload();
    }

    // --- ì°¨íŠ¸ ì—”ì§„ ---
    function initChart() {
        const el = document.getElementById("chartArea");
        chart = LightweightCharts.createChart(el, {
            layout: { background: { color: '#ffffff' }, textColor: '#333' },
            grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
            timeScale: { timeVisible: true, secondsVisible: false },
            rightPriceScale: { borderVisible: false },
        });
        series = chart.addCandlestickSeries({
            upColor: '#ff4757', downColor: '#1e90ff',
            borderUpColor: '#ff4757', borderDownColor: '#1e90ff',
            wickUpColor: '#ff4757', wickDownColor: '#1e90ff',
        });
        
        new ResizeObserver(entries => {
            if(entries.length) chart.applyOptions({ width: entries[0].contentRect.width, height: entries[0].contentRect.height });
        }).observe(el);
    }

    function resetChartData() {
        chartData = [];
        let c = coins[curIdx];
        let p = c.price;
        let t = lastTime - 60*60;
        
        for(let i=0; i<60; i++) {
            let open = p;
            // ê³¼ê±° ì°¨íŠ¸ë„ ë³€ë™ì„± ë°˜ì˜
            let move = (Math.random()-0.5) * 0.01 * c.vol; 
            let close = open * (1 + move);
            let high = Math.max(open, close) + (open*0.003);
            let low = Math.min(open, close) - (open*0.003);
            chartData.push({ time: t, open, high, low, close });
            p = close;
            t += 60;
        }
        lastTime = t;
        chartData[chartData.length-1].close = c.price;
        series.setData(chartData);
    }

    // --- ê²Œì„ ë£¨í”„ (ë“±ë½í­ ìƒí–¥) ---
    function gameLoop() {
        // 1. ë‰´ìŠ¤ ì´ë²¤íŠ¸ (í™•ë¥  5% -> ê°•ë„ ì¦ê°€)
        if(Math.random() < 0.05) {
            triggerNews();
        }

        // 2. ê°€ê²© ë³€ë™ (ê¸°ì¡´ 0.006 -> 0.012 ë¡œ 2ë°° ìƒí–¥)
        coins.forEach(c => {
            let drift = (Math.random() - 0.5) * 0.012 * c.vol;
            c.price = c.price * (1 + drift);
            if(c.price < 0.000001) c.price = 0.000001; 
        });

        // 3. ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        let cur = coins[curIdx];
        let now = Math.floor(Date.now()/1000);
        let last = chartData[chartData.length-1];

        if(now - lastTime >= 5) {
            lastTime = now;
            let nc = { time: lastTime, open: cur.price, high: cur.price, low: cur.price, close: cur.price };
            chartData.push(nc);
            series.update(nc);
        } else {
            last.close = cur.price;
            last.high = Math.max(last.high, cur.price);
            last.low = Math.min(last.low, cur.price);
            series.update(last);
        }

        updateInfo();
        renderList();
        save();
    }

    function triggerNews() {
        const news = newsData[Math.floor(Math.random() * newsData.length)];
        const targetIdx = Math.floor(Math.random() * coins.length);
        const targetCoin = coins[targetIdx];
        
        let msg = news.text.replace("{name}", targetCoin.name);
        
        if(news.type === 'info') {
            coins.forEach(c => c.price *= news.power);
        } else {
            targetCoin.price *= news.power;
        }

        let badgeClass = news.type === 'good' ? 'badge-red' : (news.type === 'bad' ? 'badge-blue' : 'badge-gray');
        let badgeText = news.type === 'good' ? 'í˜¸ì¬' : (news.type === 'bad' ? 'ì•…ì¬' : 'ë‰´ìŠ¤');

        const badge = document.getElementById('newsBadge');
        const text = document.getElementById('newsText');
        
        text.style.opacity = 0;
        setTimeout(() => {
            badge.className = "news-badge " + badgeClass;
            badge.innerText = badgeText;
            text.innerText = msg;
            text.style.opacity = 1;
        }, 300);
    }

    // --- UI ë¡œì§ ---
    function updateInfo() {
        const c = coins[curIdx];
        document.getElementById("mainCode").innerText = c.code;
        document.getElementById("mainName").innerText = c.name;
        
        const pEl = document.getElementById("mainPrice");
        const diff = c.price - c.openPrice;
        pEl.innerText = fmt(c.price);
        pEl.className = "coin-price-big " + (diff >= 0 ? "price-up" : "price-down");

        document.getElementById("myCash").innerText = Math.floor(cash).toLocaleString();
        document.getElementById("qtyUnit").innerText = c.code;
        
        const myW = wallet[c.code];
        document.getElementById("myQty").innerText = myW ? myW.qty.toFixed(4) : "0";

        let total = cash;
        coins.forEach(x => {
            if(wallet[x.code]) total += wallet[x.code].qty * x.price;
        });
        document.getElementById("totalAsset").innerText = Math.floor(total).toLocaleString();
    }

    function switchTab(t) {
        curTab = t;
        document.getElementById("tabAll").className = t==='all' ? "tab-btn active" : "tab-btn";
        document.getElementById("tabMy").className = t==='my' ? "tab-btn active" : "tab-btn";
        renderList();
    }

    function renderList() {
        const listEl = document.getElementById("coinList");
        listEl.innerHTML = "";

        let targets = coins.map((c, i) => ({...c, idx: i}));
        if(curTab === 'my') {
            targets = targets.filter(c => wallet[c.code] && wallet[c.code].qty > 0);
        }

        if(targets.length === 0) {
            listEl.innerHTML = "<div style='padding:30px; text-align:center; color:#ccc'>ë³´ìœ í•œ ì½”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            return;
        }

        targets.forEach(c => {
            const div = document.createElement("div");
            div.className = "coin-item" + (c.idx === curIdx ? " active" : "");
            div.onclick = () => changeCoin(c.idx);

            const pct = ((c.price - c.openPrice) / c.openPrice) * 100;
            const color = pct >= 0 ? "price-up" : "price-down";
            const sign = pct >= 0 ? "+" : "";
            const hasQty = wallet[c.code] && wallet[c.code].qty > 0;
            const badgeHtml = hasQty ? "<span class='holding-badge'>ë³´ìœ </span>" : "";

            let html = `
                <div class="coin-info-left">
                    <span class="name-tag">${c.name} ${badgeHtml}</span>
                    <span class="code-tag">${c.code}</span>
                </div>
                <div class="coin-info-right">
                    <div class="list-price">${fmt(c.price)}</div>
                    <div class="list-pct ${color}">${sign}${pct.toFixed(2)}%</div>
                </div>
            `;
            
            if(curTab === 'my') {
                const w = wallet[c.code];
                const profit = (c.price * w.qty) - (w.avg * w.qty);
                const profitRate = w.avg > 0 ? (profit / (w.avg * w.qty)) * 100 : 0;
                const pColor = profit >= 0 ? "profit-pos" : "profit-neg";
                
                html += `
                <div style="width:100%; margin-top:8px; padding-top:8px; border-top:1px dashed #eee; display:flex; justify-content:space-between; font-size:0.85rem;">
                    <span style="color:#777">í‰ë‹¨: ${fmt(w.avg)}</span>
                    <span class="${pColor}">ìˆ˜ìµ: ${Math.floor(profit).toLocaleString()} (${profitRate.toFixed(1)}%)</span>
                </div>
                `;
            }

            div.innerHTML = html;
            listEl.appendChild(div);
        });
    }

    function changeCoin(idx) {
        if(curIdx === idx) return;
        curIdx = idx;
        document.getElementById("tradeAmount").value = "";
        resetChartData();
        updateInfo();
        renderList();
    }

    function setMax() {
        const c = coins[curIdx];
        const val = Math.floor((cash / c.price) * 10000) / 10000;
        document.getElementById("tradeAmount").value = val > 0 ? val : 0;
    }

    function trade(type) {
        const qty = parseFloat(document.getElementById("tradeAmount").value);
        if(!qty || qty <= 0) return toast("ìˆ˜ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        
        const c = coins[curIdx];
        const amt = qty * c.price;
        const w = wallet[c.code];

        if(type === 'buy') {
            if(cash < amt) return toast("ì˜ˆìˆ˜ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            cash -= amt;
            const oldTotal = w.qty * w.avg;
            const newTotal = oldTotal + amt;
            w.qty += qty;
            w.avg = newTotal / w.qty;
            toast(`${c.name} ë§¤ìˆ˜ ì™„ë£Œ`);
        } else {
            if(w.qty < qty) return toast("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            w.qty -= qty;
            cash += amt;
            if(w.qty <= 0.000001) { w.qty = 0; w.avg = 0; }
            toast(`${c.name} ë§¤ë„ ì™„ë£Œ`);
        }
        
        save();
        updateInfo();
        renderList();
    }

    function save() {
        if(!currentUser) return;
        localStorage.setItem("btcGame_Data_" + currentUser, JSON.stringify({ cash, coins, wallet }));
    }

    function fmt(p) {
        if(p < 1) return p.toFixed(4);
        if(p < 1000) return p.toFixed(2);
        return Math.floor(p).toLocaleString();
    }

    function toast(msg) {
        const t = document.getElementById("toast");
        t.innerText = msg;
        t.style.opacity = 1;
        t.style.bottom = "50px";
        setTimeout(() => {
            t.style.opacity = 0;
            t.style.bottom = "30px";
        }, 2000);
    }

</script>
</body>
</html>