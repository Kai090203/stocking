<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Trader Pro - Perfect Chart</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* --- ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ --- */
        body { background-color: #f0f2f5; color: #333; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        
        #loginScreen { position: absolute; z-index: 1000; background: rgba(255,255,255,0.98); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center; width: 320px; border: 1px solid #e1e4e8; }
        .login-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; transition: 0.2s; }
        .btn-login { width: 100%; padding: 14px; background: #2f3542; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .login-msg { margin-top: 15px; font-size: 0.85rem; color: #ff4757; min-height: 20px; }

        .news-container { position: absolute; top: 0; width: 100%; background: #fff; height: 50px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #ddd; z-index: 10; }
        .news-badge { padding: 4px 10px; border-radius: 20px; color: white; font-size: 0.8rem; font-weight: bold; margin-right: 10px; }
        .badge-red { background: #ff4757; } .badge-blue { background: #1e90ff; } .badge-gray { background: #747d8c; }
        #newsText { font-weight: 600; font-size: 1rem; color: #2f3542; }

        .main-container { display: none; gap: 20px; width: 95%; max-width: 1100px; height: 85vh; margin-top: 60px; }
        .panel { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; border: 1px solid #e1e4e8; }
        
        .left-panel { flex: 1.8; padding: 25px; position: relative; }
        .coin-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .coin-name-big { font-size: 2rem; font-weight: 800; color: #2f3542; }
        .coin-price-big { font-size: 2.4rem; font-weight: 900; }
        .price-up { color: #ff4757; } .price-down { color: #1e90ff; }
        
        #chartArea { width: 100%; height: 380px; border: 1px solid #eee; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        
        .trade-area { background: #f8f9fa; padding: 20px; border-radius: 12px; }
        .asset-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; color: #57606f; }
        .asset-val { font-weight: bold; color: #2f3542; font-size: 1.1rem; }
        
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; margin-top: 15px; }
        .qty-input { flex: 1; padding: 14px; border: 1px solid #ced6e0; border-radius: 8px; font-size: 1.2rem; text-align: right; outline: none; font-weight: bold; }
        .btn-max { padding: 0 20px; background: #a4b0be; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .btn-row { display: flex; gap: 10px; }
        .btn-trade { flex: 1; padding: 16px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; color: white; cursor: pointer; transition: 0.1s; }
        .btn-buy { background: #ff4757; box-shadow: 0 4px 0 #d63031; } 
        .btn-sell { background: #1e90ff; box-shadow: 0 4px 0 #0984e3; } 

        .right-panel { flex: 1; display: flex; flex-direction: column; background: #fdfdfd; }
        .tab-header { display: flex; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 15px; cursor: pointer; text-align: center; font-weight: bold; color: #a4b0be; transition: 0.2s; background: #f1f2f6; }
        .tab-btn.active { background: white; color: #2f3542; border-top: 3px solid #333; }
        
        .list-container { flex: 1; overflow-y: auto; }
        .coin-item { padding: 15px 20px; border-bottom: 1px solid #f1f2f6; cursor: pointer; transition: 0.1s; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .coin-item:hover { background: #f8f9fa; }
        .coin-item.active { background: #eef2f5; border-left: 5px solid #2f3542; }
        .holding-badge { background: #2ed573; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .profit-pos { color: #ff4757; } .profit-neg { color: #1e90ff; }
        .list-price { font-weight: bold; font-size: 1.05rem; }
        .list-pct { font-size: 0.9rem; font-weight: bold; margin-top: 4px; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; font-size: 0.9rem; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="margin:0 0 10px 0;">ğŸ” Coin Trader</h2>
        <p style="color:#777; margin-bottom:20px;">ì°¨íŠ¸ ë™ê¸°í™” & ë³´ì•ˆ ì—…ë°ì´íŠ¸</p>
        <input type="text" id="username" class="login-input" placeholder="ì•„ì´ë””" onkeypress="if(event.key==='Enter') document.getElementById('password').focus()">
        <input type="password" id="password" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeypress="if(event.key==='Enter') tryLogin()">
        <button class="btn-login" onclick="tryLogin()">ì ‘ì†í•˜ê¸°</button>
        <div id="loginMsg" class="login-msg"></div>
    </div>
</div>

<div class="news-container">
    <div id="newsBadge" class="news-badge badge-gray">NEWS</div>
    <div id="newsText">ë°ì´í„° ì—°ê²° ì¤‘...</div>
    <button onclick="logout()" style="position:absolute; right:20px; padding:6px 12px; border:1px solid #ddd; background:white; cursor:pointer; border-radius:4px; font-weight:bold; color:#555;">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div class="main-container" id="mainGame">
    <div class="panel left-panel">
        <div class="coin-header">
            <div>
                <span style="font-size:0.8rem; font-weight:bold; color:#aaa;" id="mainCode">BTC</span>
                <div class="coin-name-big" id="mainName">ë¹„íŠ¸ì½”ì¸</div>
            </div>
            <div class="coin-price-big" id="mainPrice">0</div>
        </div>
        <div id="chartArea"></div>
        <div class="trade-area">
            <div class="asset-row">
                <span>ì˜ˆìˆ˜ê¸ˆ</span>
                <span class="asset-val"><span id="myCash">0</span> KRW</span>
            </div>
            <div class="asset-row">
                <span>ë³´ìœ ëŸ‰</span>
                <span class="asset-val"><span id="myQty">0</span> <span id="qtyUnit">BTC</span></span>
            </div>
            <div class="input-row">
                <input type="number" id="tradeAmount" class="qty-input" placeholder="ìˆ˜ëŸ‰">
                <button class="btn-max" onclick="setMax()">ìµœëŒ€</button>
            </div>
            <div class="btn-row">
                <button class="btn-trade btn-buy" onclick="trade('buy')">ë§¤ìˆ˜</button>
                <button class="btn-trade btn-sell" onclick="trade('sell')">ë§¤ë„</button>
            </div>
            <div style="text-align:center; margin-top:15px; color:#747d8c; font-size:0.9rem;">
                ì´ ìì‚°: <b id="totalAsset" style="color:#333">0</b> KRW
            </div>
        </div>
    </div>

    <div class="panel right-panel">
        <div class="tab-header">
            <div class="tab-btn active" id="tabAll" onclick="switchTab('all')">ğŸŒ ì „ì²´</div>
            <div class="tab-btn" id="tabMy" onclick="switchTab('my')">ğŸ’¼ ë‚´ ì§€ê°‘</div>
        </div>
        <div class="list-container" id="coinList"></div>
    </div>
</div>
<div id="toast"></div>

<script>
    // --- ë°ì´í„° ---
    const coinDb = [
        { code: "BTC", name: "ë¹„íŠ¸ì½”ì¸", price: 98500000, vol: 0.8 },
        { code: "ETH", name: "ì´ë”ë¦¬ì›€", price: 5200000, vol: 1.0 },
        { code: "XRP", name: "ë¦¬í”Œ", price: 900, vol: 1.5 },
        { code: "SOL", name: "ì†”ë¼ë‚˜", price: 210000, vol: 1.4 },
        { code: "BNB", name: "ë°”ì´ë‚¸ìŠ¤", price: 850000, vol: 0.9 },
        { code: "DOGE", name: "ë„ì§€ì½”ì¸", price: 220, vol: 3.0 },
        { code: "ADA", name: "ì—ì´ë‹¤", price: 750, vol: 1.2 },
        { code: "TRX", name: "íŠ¸ë¡ ", price: 160, vol: 1.0 },
        { code: "AVAX", name: "ì•„ë°œë€ì²´", price: 48000, vol: 1.5 },
        { code: "SHIB", name: "ì‹œë°”ì´ëˆ„", price: 0.04, vol: 4.0 },
        { code: "DOT", name: "í´ì¹´ë‹·", price: 11000, vol: 1.4 },
        { code: "LINK", name: "ì²´ì¸ë§í¬", price: 25000, vol: 1.6 },
        { code: "MATIC", name: "í´ë¦¬ê³¤", price: 1100, vol: 1.5 },
        { code: "LTC", name: "ë¼ì´íŠ¸ì½”ì¸", price: 115000, vol: 1.1 },
        { code: "BCH", name: "ë¹„íŠ¸ìºì‹œ", price: 650000, vol: 1.2 },
        { code: "UNI", name: "ìœ ë‹ˆìŠ¤ì™‘", price: 9500, vol: 1.8 },
        { code: "ETC", name: "ì´í´", price: 32000, vol: 2.0 },
        { code: "XLM", name: "ìŠ¤í…”ë¼", price: 190, vol: 1.3 },
        { code: "SAND", name: "ìƒŒë“œë°•ìŠ¤", price: 850, vol: 2.2 },
        { code: "PEPE", name: "í˜í˜", price: 0.008, vol: 5.0 }
    ];

    const newsData = [
        { type: 'good', text: "{name}, ëŒ€ê¸°ì—… ê²°ì œ ë„ì…!", power: 1.12 },
        { type: 'good', text: "ê¸°ê´€, {name} ëŒ€ëŸ‰ ë§¤ì§‘", power: 1.08 },
        { type: 'good', text: "SEC, {name} ETF ìŠ¹ì¸ ì„ë°•", power: 1.15 },
        { type: 'bad', text: "{name} ì¬ë‹¨, ë¬¼ëŸ‰ ë¤í•‘ ì˜í˜¹", power: 0.85 },
        { type: 'bad', text: "ê±°ë˜ì†Œ, {name} ìœ ì˜ ì¢…ëª© ì§€ì •", power: 0.80 },
        { type: 'bad', text: "ì£¼ìš”êµ­, {name} ê·œì œ ê°•í™”", power: 0.90 },
        { type: 'info', text: "ë¯¸ ì—°ì¤€ ê¸ˆë¦¬ ë™ê²° ì‹œì‚¬", power: 1.03 },
        { type: 'info', text: "ë¹„íŠ¸ì½”ì¸ ë°˜ê°ê¸° ê¸°ëŒ€ê°", power: 1.02 }
    ];

    let currentUser = "";
    let cash = 10000000;
    let coins = []; 
    let wallet = {};
    let curIdx = 0;
    let curTab = 'all';
    let chart, series;
    let loopId;
    
    // ê¸€ë¡œë²Œ ì‹œê°„ (ëª¨ë“  ì°¨íŠ¸ ë™ê¸°í™”ìš©)
    let globalTime = Math.floor(Date.now()/1000);

    // --- ë¡œê·¸ì¸ ---
    function tryLogin() {
        const id = document.getElementById("username").value.trim();
        const pw = document.getElementById("password").value.trim();
        const msg = document.getElementById("loginMsg");
        
        if(!id || !pw) return msg.innerText = "ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";

        let userDB = JSON.parse(localStorage.getItem("btcGame_Users") || "{}");
        if(userDB.hasOwnProperty(id)) {
            if(userDB[id] === pw) gameStart(id);
            else msg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
        } else {
            userDB[id] = pw;
            localStorage.setItem("btcGame_Users", JSON.stringify(userDB));
            alert("ìƒˆ ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
            gameStart(id);
        }
    }

    function gameStart(id) {
        currentUser = id;
        loadGameData();
        
        document.getElementById("loginScreen").style.display = 'none';
        document.getElementById("mainGame").style.display = 'flex';
        
        initChart();
        // *** ì¤‘ìš”: ì´ˆê¸° ë¡œë”© ì‹œ ì°¨íŠ¸ ë°ì´í„° ì…‹íŒ… ***
        series.setData(coins[curIdx].history); 
        
        updateInfo();
        renderList();
        
        if(loopId) clearInterval(loopId);
        loopId = setInterval(gameLoop, 1000); 
    }

    function loadGameData() {
        const key = "btcGame_Data_v17_" + currentUser;
        const saved = localStorage.getItem(key);
        
        if(saved) {
            const data = JSON.parse(saved);
            cash = data.cash;
            wallet = data.wallet;
            // ì½”ì¸ ì •ë³´ + íˆìŠ¤í† ë¦¬ ë³µì›
            coins = coinDb.map(init => {
                const found = data.coins.find(c => c.code === init.code);
                if(found) {
                    return found; // ê¸°ì¡´ íˆìŠ¤í† ë¦¬ ìœ ì§€
                } else {
                    return generateInitialCoin(init); // ì‹ ê·œ ì½”ì¸
                }
            });
        } else {
            // ìµœì´ˆ ì‹¤í–‰
            cash = 10000000;
            wallet = {};
            coins = coinDb.map(c => generateInitialCoin(c));
        }
    }

    // ì´ˆê¸° ì°¨íŠ¸ ë°ì´í„° ìƒì„± (ëª¨ë“  ì½”ì¸ì— ëŒ€í•´ í•œ ë²ˆë§Œ ì‹¤í–‰)
    function generateInitialCoin(c) {
        let newCoin = JSON.parse(JSON.stringify(c));
        newCoin.openPrice = c.price;
        newCoin.history = [];
        
        let p = c.price;
        let t = globalTime - 60 * 60; // 1ì‹œê°„ ì „ë¶€í„°
        
        for(let i=0; i<60; i++) {
            let open = p;
            let move = (Math.random()-0.5) * 0.01 * c.vol;
            let close = open * (1 + move);
            let high = Math.max(open, close) * 1.002;
            let low = Math.min(open, close) * 0.998;
            
            newCoin.history.push({ time: t, open, high, low, close });
            p = close;
            t += 60;
        }
        newCoin.price = p; // í˜„ì¬ê°€ ì—…ë°ì´íŠ¸
        return newCoin;
    }

    function logout() {
        save();
        location.reload();
    }

    // --- ì°¨íŠ¸ ì„¤ì • ---
    function initChart() {
        const el = document.getElementById("chartArea");
        chart = LightweightCharts.createChart(el, {
            layout: { background: { color: '#ffffff' }, textColor: '#333' },
            grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
            timeScale: { timeVisible: true, secondsVisible: false },
            rightPriceScale: { borderVisible: false },
        });
        series = chart.addCandlestickSeries({
            upColor: '#ff4757', downColor: '#1e90ff',
            borderUpColor: '#ff4757', borderDownColor: '#1e90ff',
            wickUpColor: '#ff4757', wickDownColor: '#1e90ff',
        });
        new ResizeObserver(entries => {
            if(entries.length) chart.applyOptions({ width: entries[0].contentRect.width, height: entries[0].contentRect.height });
        }).observe(el);
    }

    // --- ê²Œì„ ë£¨í”„ (í•µì‹¬ ìˆ˜ì •) ---
    function gameLoop() {
        // 1. ë‰´ìŠ¤
        if(Math.random() < 0.05) triggerNews();

        // 2. ëª¨ë“  ì½”ì¸ ì—…ë°ì´íŠ¸ (ë°±ê·¸ë¼ìš´ë“œ ì°¨íŠ¸ ìƒì„±)
        let now = Math.floor(Date.now()/1000);
        let isNewCandle = (now - globalTime >= 5); // 5ì´ˆë§ˆë‹¤ ìƒˆ ë´‰
        
        if(isNewCandle) globalTime = now;

        coins.forEach((c, i) => {
            // ê°€ê²© ë³€ë™
            let drift = (Math.random() - 0.5) * 0.012 * c.vol;
            c.price = c.price * (1 + drift);
            if(c.price < 0.000001) c.price = 0.000001;

            // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
            let lastCandle = c.history[c.history.length - 1];
            
            if (isNewCandle) {
                // ìƒˆ ë´‰ ì¶”ê°€
                let nc = { time: globalTime, open: c.price, high: c.price, low: c.price, close: c.price };
                c.history.push(nc);
                // ë©”ëª¨ë¦¬ ê´€ë¦¬ (ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ì•ë¶€ë¶„ ì‚­ì œ - 200ê°œ ìœ ì§€)
                if(c.history.length > 200) c.history.shift();
                
                // í˜„ì¬ ë³´ê³  ìˆëŠ” ì½”ì¸ì´ë©´ ì°¨íŠ¸ì— ë°˜ì˜
                if(i === curIdx) series.update(nc);
            } else {
                // í˜„ì¬ ë´‰ ê°±ì‹ 
                lastCandle.close = c.price;
                lastCandle.high = Math.max(lastCandle.high, c.price);
                lastCandle.low = Math.min(lastCandle.low, c.price);
                
                // í˜„ì¬ ë³´ê³  ìˆëŠ” ì½”ì¸ì´ë©´ ì°¨íŠ¸ì— ë°˜ì˜
                if(i === curIdx) series.update(lastCandle);
            }
        });

        updateInfo();
        renderList();
        save();
    }

    // --- UI ë° ê¸°ëŠ¥ ---
    function triggerNews() {
        const news = newsData[Math.floor(Math.random() * newsData.length)];
        const targetIdx = Math.floor(Math.random() * coins.length);
        const targetCoin = coins[targetIdx];
        
        if(news.type === 'info') coins.forEach(c => c.price *= news.power);
        else targetCoin.price *= news.power;

        const badge = document.getElementById('newsBadge');
        const text = document.getElementById('newsText');
        const cls = news.type === 'good' ? 'badge-red' : (news.type === 'bad' ? 'badge-blue' : 'badge-gray');
        
        text.style.opacity = 0;
        setTimeout(() => {
            badge.className = "news-badge " + cls;
            badge.innerText = news.type === 'good' ? 'í˜¸ì¬' : (news.type === 'bad' ? 'ì•…ì¬' : 'ë‰´ìŠ¤');
            text.innerText = news.text.replace("{name}", targetCoin.name);
            text.style.opacity = 1;
        }, 300);
    }

    function changeCoin(idx) {
        if(curIdx === idx) return;
        curIdx = idx;
        document.getElementById("tradeAmount").value = "";
        
        // *** í•µì‹¬: ì €ì¥ëœ íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ***
        series.setData(coins[curIdx].history);
        
        updateInfo();
        renderList();
    }

    function updateInfo() {
        const c = coins[curIdx];
        document.getElementById("mainCode").innerText = c.code;
        document.getElementById("mainName").innerText = c.name;
        
        const pEl = document.getElementById("mainPrice");
        const diff = c.price - c.openPrice;
        pEl.innerText = fmt(c.price);
        pEl.className = "coin-price-big " + (diff >= 0 ? "price-up" : "price-down");

        document.getElementById("myCash").innerText = Math.floor(cash).toLocaleString();
        document.getElementById("qtyUnit").innerText = c.code;
        const w = wallet[c.code] || { qty: 0 };
        document.getElementById("myQty").innerText = w.qty > 0 ? w.qty.toFixed(4) : "0";

        let total = cash;
        coins.forEach(x => { if(wallet[x.code]) total += wallet[x.code].qty * x.price; });
        document.getElementById("totalAsset").innerText = Math.floor(total).toLocaleString();
    }

    function renderList() {
        const listEl = document.getElementById("coinList");
        listEl.innerHTML = "";
        let targets = coins.map((c, i) => ({...c, idx: i}));
        if(curTab === 'my') targets = targets.filter(c => wallet[c.code] && wallet[c.code].qty > 0);

        if(targets.length === 0) {
            listEl.innerHTML = "<div style='padding:30px; text-align:center; color:#ccc'>í‘œì‹œí•  ì½”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            return;
        }

        targets.forEach(c => {
            const div = document.createElement("div");
            div.className = "coin-item" + (c.idx === curIdx ? " active" : "");
            div.onclick = () => changeCoin(c.idx);

            const pct = ((c.price - c.openPrice) / c.openPrice) * 100;
            const color = pct >= 0 ? "price-up" : "price-down";
            const w = wallet[c.code] || { qty: 0 };
            const badge = w.qty > 0 ? "<span class='holding-badge'>ë³´ìœ </span>" : "";

            let html = `
                <div class="coin-info-left">
                    <span class="name-tag">${c.name} ${badge}</span>
                    <span style="font-size:0.8rem; color:#aaa;">${c.code}</span>
                </div>
                <div class="coin-info-right">
                    <div class="list-price">${fmt(c.price)}</div>
                    <div class="list-pct ${color}">${pct >= 0 ? "+" : ""}${pct.toFixed(2)}%</div>
                </div>
            `;
            
            if(curTab === 'my') {
                const profit = (c.price * w.qty) - (w.avg * w.qty);
                const rate = w.avg > 0 ? (profit / (w.avg * w.qty)) * 100 : 0;
                html += `<div style="width:100%; margin-top:8px; padding-top:8px; border-top:1px dashed #eee; font-size:0.85rem; display:flex; justify-content:space-between;">
                    <span style="color:#777">í‰ë‹¨: ${fmt(w.avg)}</span>
                    <span class="${profit >= 0 ? 'profit-pos' : 'profit-neg'}">ìˆ˜ìµ: ${Math.floor(profit).toLocaleString()} (${rate.toFixed(1)}%)</span>
                </div>`;
            }
            div.innerHTML = html;
            listEl.appendChild(div);
        });
    }

    function trade(type) {
        const qty = parseFloat(document.getElementById("tradeAmount").value);
        if(!qty || qty <= 0) return toast("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”");
        const c = coins[curIdx];
        const amt = qty * c.price;
        
        if(!wallet[c.code]) wallet[c.code] = { qty: 0, avg: 0 };
        const w = wallet[c.code];

        if(type === 'buy') {
            if(cash < amt) return toast("ì˜ˆìˆ˜ê¸ˆ ë¶€ì¡±");
            cash -= amt;
            const oldVal = w.qty * w.avg;
            w.qty += qty;
            w.avg = (oldVal + amt) / w.qty;
            toast("ë§¤ìˆ˜ ì™„ë£Œ!");
        } else {
            if(w.qty < qty) return toast("ë³´ìœ ëŸ‰ ë¶€ì¡±");
            w.qty -= qty;
            cash += amt;
            if(w.qty <= 0.000001) { w.qty = 0; w.avg = 0; }
            toast("ë§¤ë„ ì™„ë£Œ!");
        }
        save(); updateInfo(); renderList();
    }

    function setMax() {
        const c = coins[curIdx];
        const val = Math.floor((cash / c.price) * 10000) / 10000;
        document.getElementById("tradeAmount").value = val > 0 ? val : 0;
    }

    function save() {
        if(currentUser) localStorage.setItem("btcGame_Data_v17_" + currentUser, JSON.stringify({ cash, coins, wallet }));
    }
    
    function switchTab(t) { 
        curTab = t; 
        document.getElementById("tabAll").className = t==='all'?"tab-btn active":"tab-btn";
        document.getElementById("tabMy").className = t==='my'?"tab-btn active":"tab-btn";
        renderList(); 
    }
    
    function fmt(p) { return p < 1 ? p.toFixed(4) : (p < 1000 ? p.toFixed(2) : Math.floor(p).toLocaleString()); }
    
    function toast(m) {
        const t = document.getElementById("toast");
        t.innerText = m; t.style.opacity=1; t.style.bottom="50px";
        setTimeout(() => { t.style.opacity=0; t.style.bottom="30px"; }, 2000);
    }
</script>
</body>
</html>